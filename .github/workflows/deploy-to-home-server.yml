name: Deploy to production server
run-name: Deploying ${{ github.sha }} to production server

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

env:
  FRONTEND_IMAGE_NAME: mora-jai

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t ${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }} ./packages/frontend
          docker tag ${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }} ${{ env.FRONTEND_IMAGE_NAME }}:latest

      - name: Save Docker image to tar
        run: |
          docker save ${{ env.FRONTEND_IMAGE_NAME }}:latest | gzip > ${{ env.FRONTEND_IMAGE_NAME }}.tar.gz

      - name: Copy image to home server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.HOME_SERVER_HOST }}
          username: ${{ secrets.HOME_SERVER_USER }}
          key: ${{ secrets.HOME_SERVER_SSH_KEY }}
          port: ${{ secrets.HOME_SERVER_PORT }}
          source: "${{ env.FRONTEND_IMAGE_NAME }}.tar.gz,docker-compose.yml"
          target: "/tmp/mora-jai-deployment/"

      - name: Deploy on home server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOME_SERVER_HOST }}
          username: ${{ secrets.HOME_SERVER_USER }}
          key: ${{ secrets.HOME_SERVER_SSH_KEY }}
          port: ${{ secrets.HOME_SERVER_PORT }}
          script: |
            cd /tmp/mora-jai-deployment
            
            # Load the new image
            docker load < ${{ env.FRONTEND_IMAGE_NAME }}.tar.gz
            
            # Stop existing containers
            docker-compose down || true
            
            # Start new containers with environment variables
            MORA_JAI_PORT=${{ secrets.MORA_JAI_PORT }} \
            MORA_JAI_INTERNAL_PORT=${{ secrets.MORA_JAI_INTERNAL_PORT }} \
            MORA_JAI_FRONTEND_CONTAINER=${{ secrets.MORA_JAI_FRONTEND_CONTAINER }} \
            MORA_JAI_IMAGE=${{ env.FRONTEND_IMAGE_NAME }}:latest \
            NODE_ENV=production \
            docker-compose up -d
            
            # Clean up old images (keep last 3)
            docker image prune -f
            docker images ${{ env.FRONTEND_IMAGE_NAME }} --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}" | tail -n +4 | awk '{print $3}' | head -n -3 | xargs -r docker rmi
            
            # Clean up deployment files
            rm -f ${{ env.FRONTEND_IMAGE_NAME }}.tar.gz

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOME_SERVER_HOST }}
          username: ${{ secrets.HOME_SERVER_USER }}
          key: ${{ secrets.HOME_SERVER_SSH_KEY }}
          port: ${{ secrets.HOME_SERVER_PORT }}
          script: |
            # Check if container is running
            if docker ps | grep -q mora-jai-frontend; then
              echo "✅ Container is running successfully"
              docker ps | grep mora-jai-frontend
            else
              echo "❌ Container failed to start"
              docker ps -a | grep mora-jai-frontend
              exit 1
            fi
            
            # Test HTTP response (using environment variable for port)
            sleep 10  # Wait for container to fully start
            PORT=${{ secrets.MORA_JAI_PORT }}
            if curl -f http://localhost:${PORT} > /dev/null 2>&1; then
              echo "✅ Application is responding to HTTP requests on port ${PORT}"
            else
              echo "❌ Application is not responding on port ${PORT}"
              exit 1
            fi